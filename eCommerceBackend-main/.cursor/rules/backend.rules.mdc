---
description: >
  BACKEND: Node.js + Express + Mongoose + REST API + JWT Auth + Webhooks (externos).
  USE WHEN: creando o modificando c√≥digo en `src/server/**`, `src/routes/**`, `src/controllers/**`, `src/models/**`, `src/services/**`, o `src/webhooks/**`.
globs:
  - "src/server/**"
  - "src/routes/**"
  - "src/controllers/**"
  - "src/models/**"
  - "src/services/**"
  - "src/config/**"
  - "src/webhooks/**"
alwaysApply: false
---

# üéØ Objetivo
Estandarizar el backend en Node.js con Express y Mongoose, asegurando una arquitectura limpia, validaciones fuertes, manejo consistente de errores, seguridad en autenticaci√≥n y operaciones idempotentes en webhooks.

# ‚úÖ Principios obligatorios
- **TypeScript estricto**: sin `any`. Tipar `req`, `res` y modelos correctamente.
- **Validaci√≥n de entrada**: usar **Zod** o **express-validator** en todos los endpoints (body, query, params).
- **Separaci√≥n por capas**:
  - `routes/`: define endpoints y middlewares.
  - `controllers/`: orquesta l√≥gica, maneja errores y respuestas.
  - `services/`: contiene la l√≥gica de negocio.
  - `models/`: define esquemas y m√©todos Mongoose.
- **Conexi√≥n DB**: una sola conexi√≥n Mongoose, controlada en `src/config/db.ts`.
- **Errores**: manejo centralizado con `middleware/errorHandler.ts`, devolviendo JSON estructurado.
- **Logs y auditor√≠a**: registrar errores cr√≠ticos y eventos de negocio con contexto (requestId, userId, entidad).
- **Seguridad**: sanitizar entradas, validar JWTs, y proteger endpoints sensibles.

# üß© Arquitectura y convenciones
- **Carpetas**
  - `src/server/`: punto de entrada (`server.ts` o `app.ts`), configuraci√≥n base, middlewares globales.
  - `src/config/`: conexi√≥n a MongoDB, variables de entorno, JWT, etc.
  - `src/routes/`: define los endpoints REST agrupados por recurso.
  - `src/controllers/`: l√≥gica de orquestaci√≥n (sin l√≥gica de negocio).
  - `src/services/`: l√≥gica de negocio, acceso a datos, integraci√≥n con SDKs externos.
  - `src/models/`: definici√≥n de esquemas Mongoose y validaciones.
  - `src/webhooks/`: recepci√≥n e idempotencia de eventos externos (ej. Mercado Pago).
- **Imports**
  - Absolutos con `@/` definidos en `tsconfig.json` (`baseUrl` y `paths`).
  - No duplicar funciones entre controladores y servicios.
- **Naming**
  - Archivos de rutas: `user.routes.ts`, `order.routes.ts`.
  - Controladores: `user.controller.ts`, `order.controller.ts`.
  - Servicios: `user.service.ts`, `payment.service.ts`.
  - Modelos: `User.ts`, `Order.ts`, `Payment.ts`.

# üîê Seguridad
- **Autenticaci√≥n JWT**:
  - Tokens firmados con secret en `.env`.
  - Middleware `authMiddleware` para validar y decodificar token.
  - Usar `req.user` tipado para contexto de sesi√≥n.
- **Validaciones y sanitizaci√≥n**:
  - Nunca confiar en input del cliente.
  - Validar IDs con `mongoose.Types.ObjectId.isValid`.
- **Webhooks seguros**:
  - Validar firma o token secreto.
  - Re-consultar con el proveedor antes de persistir (anti-spoof).
  - Implementar **idempotencia**: colecci√≥n `processed_events(provider, event_id UNIQUE)`.
  - Si el evento ya existe ‚Üí devolver `200 OK` sin reprocesar.
- **Roles y permisos**:
  - Middleware `authorize(role[])` para proteger rutas sensibles.
  - Evitar exponer campos privados en respuestas (usar `.select('-password')`).

# üí≥ Pagos y Webhooks 
- **Spot**:
  - Recibir `payment_id` ‚Üí re-consultar en MP ‚Üí validar estado y metadata ‚Üí marcar orden como pagada.
  - Persistir en `payments` con esquema validado.
- **Recurrencia**:
  - Manejar `preapproval` y `authorized_payment` con persistencia y asignaci√≥n de beneficios.
- **Idempotencia**:
  - Registrar cada evento en `processed_events`.
  - Log de entrada/salida en `webhooks_log` con `status_code` y `payload`.
- **Errores**:
  - Responder `500` para reintentos autom√°ticos del proveedor.
  - Solo responder `200` cuando la persistencia fue exitosa.

# üóÉÔ∏è Datos m√≠nimos (colecciones gu√≠a)
- `users(_id, name, email UNIQUE, password, role, createdAt, updatedAt)`
- `orders(_id, userId, items[], totalAmount, status, createdAt)`
- `payments(_id, orderId, provider, providerPaymentId UNIQUE, status, amount, currency, rawPayload)`
- `processed_events(provider, event_id UNIQUE, receivedAt)`
- `webhooks_log(provider, topic, external_id?, deliveredAt, status_code, error?, payload)`

# üõ†Ô∏è Tooling
- **TypeScript** con `"strict": true` y `"noImplicitAny": true`.
- **Zod** o **express-validator**
